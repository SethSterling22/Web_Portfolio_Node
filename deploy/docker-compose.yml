# Made by: Sebasti√°n Sterling üê≥

# Initialization of services
services:

  ####################################################################
  ############ POSTGRESQL ############ 
  # 1. PostgreSQL Service
  # portfolio-db:
  #   image: postgres:15-alpine
  #   container_name: portfolio-postgres
  #   restart: always
    
  #   # PostgreSQL cretendentials
  #   env_file: ./.env
  
  #   volumes:
  #     # Data persistance
  #     - postgres_data:/var/lib/postgresql/data
  #     # Initialization Script of the Database
  #     - ./init-db:/docker-entrypoint-initdb.d
  #   networks:
  #     # Accessible just from the API network
  #     - db_backend_net


  ############ MYSQL ############ 
  # portfolio-db:
  #   # MySQL image (version 8.0)
  #   image: mysql:8.0
  #   container_name: portfolio-mysql
  #   restart: always

  #   # Load Env-File
  #   env_file: ./.env
  #   environment:
  #     MYSQL_ROOT_PASSWORD: ${DB_PASSWORD} 
  #     MYSQL_DATABASE: ${DB_NAME}
  #     MYSQL_USER: ${DB_USER}
  #     MYSQL_PASSWORD: ${DB_PASSWORD}

  #   volumes:
  #     # Data Persistence
  #     - mysql_data:/var/lib/mysql

  #     # Database inicialization
  #     # The Script must be .sql o .sh
  #     - ./init-db-mysql:/docker-entrypoint-initdb.d
    
  #   networks:
  #     # Accessible just from the API networs
  #     - db_backend_net


  ############ MSSQL ############ 
  portfolio-db:
    # Official MS SQL Server image
    image: mcr.microsoft.com/mssql/server:latest
    container_name: portfolio-mssql
    restart: always

    # Load Env-File
    env_file: ./.env
    environment:
      # IMPORTANT: Strong password is required by MS SQL Server
      MSSQL_SA_PASSWORD: ${DB_PASSWORD}
      # IMPORTANT: Accept the End-User License Agreement
      ACCEPT_EULA: "Y" 
      MSSQL_DB: ${DB_NAME}

    volumes:
      # Data Persistence
      - mssql_data:/var/opt/mssql
      - ./init-db-mssql/init-db-mssql.sql:/db/init.sql
      - ./init-db-mssql/entrypoint.sh:/entrypoint.sh
    
    # Execute the database initialization
    entrypoint: ["/bin/bash", "/entrypoint.sh"]

    networks:
      # Accessible just from the API networs
      - db_backend_net


  ####################################################################
  # 2. Node.js API Service (Backend)
  portfolio-api:
    build:
      context: ../api
      dockerfile: ./dockerfile
    # image: my-node-api:latest
    container_name: portfolio-api
    restart: unless-stopped
    
    # Load .env file in the API project
    env_file:
      - ../api/src/config/.env

    environment:
      DB_SERVER: portfolio-db # Use the DB service name as Host (also in the .env for redundancy)
      
    depends_on:
      - portfolio-db
      - tailscale-proxy
    network_mode: service:tailscale-proxy


  ####################################################################
  # 3. Tailscale Service (Proxy)
  tailscale-proxy:
    image: tailscale/tailscale:latest
    hostname: tailscale-funnel
    container_name: tailscale-funnel
    cap_add:
      - NET_ADMIN 
    devices:
      - /dev/net/tun:/dev/net/tun

    # IMPORTANT: you must add your Tailscale authentication key
    env_file: ./.env

    networks:
      # Connection bridge
      - db_backend_net
    
    
        
### Networks declaration
networks:
  db_backend_net:
    driver: bridge
  
### Data persistence (Comment or Uncomment the volume depending on the database selected)
volumes:
  # postgres_data:
  # mysql_data:
  mssql_data:


####################################################################
# How to run it:
#   sudo docker compose build --no-cache && sudo docker compose up -d

# After all the containers were created, the next command must be executed to activate the service:
#   sudo docker exec tailscale-funnel tailscale funnel --bg 5000

# To see what's happening:
#   sudo docker compose logs -f

# To recreate a single container in the compose file:
#   sudo docker compose up -d --build {SERVICE_NAME}

